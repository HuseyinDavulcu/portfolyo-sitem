<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lojistik Yükleme Planlayıcısı (Excel Destekli)</title>
    <!-- Tailwind CSS (Hızlı Tasarım İçin) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (İkonlar İçin) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS (Excel Okuma/Yazma İçin) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .pallet-box { transition: all 0.3s ease; }
        .pallet-box:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        /* Dosya Yükleme Alanı Animasyonu */
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s ease; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Üst Başlık -->
    <header class="bg-blue-800 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold"><i class="fa-solid fa-truck-ramp-box mr-2"></i> Lojistik Optimizasyon Aracı</h1>
            <div class="space-x-2">
                <button onclick="clearAll()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm transition">
                    <i class="fa-solid fa-trash"></i> Temizle
                </button>
                <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm transition">
                    <i class="fa-solid fa-print"></i> Rapor Yazdır
                </button>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6 mt-4">
        
        <!-- SOL PANEL: Veri Girişi -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- 1. Palet / Konteyner Ayarları -->
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-blue-600">
                <h2 class="text-lg font-semibold mb-4 text-blue-800 border-b pb-2">1. Palet / Araç Standartları</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">En (cm)</label>
                        <input type="number" id="pal-width" value="80" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Boy (cm)</label>
                        <input type="number" id="pal-length" value="120" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Max Yükseklik (cm)</label>
                        <input type="number" id="pal-height" value="180" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Max Ağırlık (kg)</label>
                        <input type="number" id="pal-weight" value="1000" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>
            </div>

            <!-- EXCEL İLE YÜKLEME ALANI (YENİ) -->
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-orange-500">
                <div class="flex justify-between items-center mb-2 border-b pb-2">
                    <h2 class="text-lg font-semibold text-orange-700">Toplu Yükleme (Excel)</h2>
                    <button onclick="downloadTemplate()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded border border-gray-300 transition">
                        <i class="fa-solid fa-download"></i> Şablon İndir
                    </button>
                </div>
                
                <div class="drop-zone p-6 rounded-lg text-center cursor-pointer relative" onclick="document.getElementById('excel-file').click()">
                    <i class="fa-solid fa-file-excel text-3xl text-green-600 mb-2"></i>
                    <p class="text-sm text-gray-600">Excel dosyasını buraya sürükleyin veya <span class="text-blue-600 font-bold underline">tıklayarak seçin</span>.</p>
                    <input type="file" id="excel-file" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(event)">
                </div>
                <p id="upload-status" class="text-xs text-gray-400 mt-2 text-center"></p>
            </div>

            <!-- 2. Manuel Ürün Ekleme -->
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-green-600">
                <h2 class="text-lg font-semibold mb-4 text-green-800 border-b pb-2">Manuel Ürün Ekle</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Ürün Adı / Kodu</label>
                        <input type="text" id="item-name" placeholder="Örn: Koli A Tipi" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-green-400">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs font-bold text-gray-600">En (cm)</label>
                            <input type="number" id="item-width" class="w-full border rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600">Boy (cm)</label>
                            <input type="number" id="item-length" class="w-full border rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600">Yüks (cm)</label>
                            <input type="number" id="item-height" class="w-full border rounded p-2">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-bold text-gray-600">Ağırlık (kg)</label>
                            <input type="number" id="item-weight" class="w-full border rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600">Adet</label>
                            <input type="number" id="item-qty" value="1" class="w-full border rounded p-2">
                        </div>
                    </div>
                    <button onclick="addItem()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition mt-2">
                        <i class="fa-solid fa-plus"></i> Listeye Ekle
                    </button>
                </div>
            </div>

            <!-- Eklenecek Ürün Listesi -->
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">Yüklenecek Liste</h3>
                    <span id="total-items-count" class="bg-gray-200 text-gray-700 text-xs px-2 py-1 rounded">0 Ürün</span>
                </div>
                <div id="items-list" class="space-y-2 max-h-64 overflow-y-auto text-sm">
                    <p class="text-gray-400 text-center py-4 italic">Henüz ürün eklenmedi.</p>
                </div>
                <button onclick="calculateLoad()" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded shadow-lg transition transform hover:scale-105">
                    <i class="fa-solid fa-calculator"></i> PLANLAMAYI BAŞLAT
                </button>
            </div>
        </div>

        <!-- SAĞ PANEL: Sonuçlar -->
        <div class="lg:col-span-8">
            <div class="bg-white p-6 rounded-lg shadow-md min-h-screen">
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Yükleme Planı Sonuçları</h2>
                    <div id="summary-stats" class="text-sm text-gray-600 hidden">
                        <!-- Özet istatistikler buraya gelecek -->
                    </div>
                </div>

                <div id="results-area" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-1 md:col-span-2 text-center py-20 text-gray-400">
                        <i class="fa-solid fa-cubes-stacked text-6xl mb-4"></i>
                        <p class="text-lg">Soldaki panelden Excel yükleyin veya ürünleri ekleyip "Planlamayı Başlat" butonuna basın.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Mantığı -->
    <script>
        // Veri Saklama Alanı
        let cargoItems = [];
        let itemCounter = 0;

        // --- EXCEL İŞLEMLERİ ---

        // Şablon İndir
        function downloadTemplate() {
            // Basit bir veri seti oluştur
            const ws_data = [
                ["Urun Adi", "En", "Boy", "Yukseklik", "Agirlik", "Adet"], // Başlıklar
                ["Koli A", 40, 60, 40, 15, 10], // Örnek Veri 1
                ["Koli B", 30, 30, 30, 5, 20]   // Örnek Veri 2
            ];
            
            // Workbook oluştur
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Urun Listesi");

            // Dosyayı indir
            XLSX.writeFile(wb, "yukleme_sablonu.xlsx");
        }

        // Excel Yükleme ve Okuma
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const statusEl = document.getElementById('upload-status');
            
            if (!file) return;

            statusEl.textContent = "Dosya okunuyor...";

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});

                // İlk sayfayı al
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // JSON'a çevir (Başlık satırını kullanarak)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval:""});

                if (jsonData.length === 0) {
                    alert("Excel dosyası boş veya okunamadı!");
                    statusEl.textContent = "Hata: Boş dosya.";
                    return;
                }

                // Verileri Parse Et ve cargoItems'a ekle
                let addedCount = 0;
                
                jsonData.forEach(row => {
                    // Excel başlıkları biraz esnek olsun (Büyük/Küçük harf, Türkçe karakter)
                    // Kullanıcı başlıkları tam tutturamazsa diye keys'leri kontrol edelim.
                    // En garantisi, sırasıyla veya olası isimlerle eşleştirmektir.
                    // Biz Şablon'a sadık kaldıklarını varsayarak işlem yapacağız ama
                    // Basit bir "mapping" yapalım.
                    
                    const name = row["Urun Adi"] || row["Ürün Adı"] || row["Name"] || `Excel Ürün ${itemCounter+1}`;
                    const w = parseFloat(row["En"] || row["Width"] || 0);
                    const l = parseFloat(row["Boy"] || row["Length"] || 0);
                    const h = parseFloat(row["Yukseklik"] || row["Yükseklik"] || row["Height"] || 0);
                    const weight = parseFloat(row["Agirlik"] || row["Ağırlık"] || row["Weight"] || 0);
                    const qty = parseInt(row["Adet"] || row["Miktar"] || row["Qty"] || 1);

                    // Sadece geçerli boyutları olanları ekle
                    if (w > 0 && l > 0 && h > 0 && weight > 0 && qty > 0) {
                        const volume = w * l * h;
                        cargoItems.push({
                            id: ++itemCounter,
                            name: name,
                            w: w, l: l, h: h,
                            weight: weight,
                            volume: volume,
                            qty: qty
                        });
                        addedCount++;
                    }
                });

                renderItemsList();
                statusEl.textContent = `${addedCount} ürün başarıyla yüklendi!`;
                statusEl.className = "text-xs text-green-600 mt-2 text-center font-bold";
                
                // Input'u temizle ki aynı dosyayı tekrar seçebilsin
                event.target.value = "";
            };

            reader.readAsArrayBuffer(file);
        }

        // --- MANUEL İŞLEMLER ---

        function addItem() {
            const name = document.getElementById('item-name').value || `Ürün ${itemCounter + 1}`;
            const w = parseFloat(document.getElementById('item-width').value);
            const l = parseFloat(document.getElementById('item-length').value);
            const h = parseFloat(document.getElementById('item-height').value);
            const weight = parseFloat(document.getElementById('item-weight').value);
            const qty = parseInt(document.getElementById('item-qty').value);

            if (!w || !l || !h || !weight || !qty) {
                alert("Lütfen tüm alanları doldurunuz.");
                return;
            }

            const volume = w * l * h;

            cargoItems.push({
                id: ++itemCounter,
                name: name,
                w: w, l: l, h: h,
                weight: weight,
                volume: volume,
                qty: qty
            });

            renderItemsList();
            
            document.getElementById('item-name').value = "";
            document.getElementById('item-qty').value = "1";
            document.getElementById('item-name').focus();
        }

        function renderItemsList() {
            const listEl = document.getElementById('items-list');
            const countEl = document.getElementById('total-items-count');
            
            let totalQty = cargoItems.reduce((acc, item) => acc + item.qty, 0);
            countEl.textContent = `${totalQty} Parça`;

            if (cargoItems.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-center py-4 italic">Henüz ürün eklenmedi.</p>';
                return;
            }

            let html = '';
            // Listeyi ters çevirip gösterelim ki son eklenen en üstte olsun
            [...cargoItems].reverse().forEach((item) => {
                // Orijinal indexi bulmak lazım silme işlemi için
                const originalIndex = cargoItems.indexOf(item); 
                html += `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200">
                        <div>
                            <div class="font-bold text-gray-700">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.w}x${item.l}x${item.h} cm | ${item.weight} kg</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded">x${item.qty}</span>
                            <button onclick="deleteItem(${originalIndex})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }

        function deleteItem(index) {
            cargoItems.splice(index, 1);
            renderItemsList();
        }

        function clearAll() {
            if(confirm("Tüm listeyi ve sonuçları silmek istediğinize emin misiniz?")) {
                cargoItems = [];
                itemCounter = 0;
                renderItemsList();
                document.getElementById('results-area').innerHTML = `
                    <div class="col-span-1 md:col-span-2 text-center py-20 text-gray-400">
                        <i class="fa-solid fa-cubes-stacked text-6xl mb-4"></i>
                        <p class="text-lg">Soldaki panelden ürünleri ekleyin ve "Planlamayı Başlat" butonuna basın.</p>
                    </div>`;
                document.getElementById('summary-stats').classList.add('hidden');
            }
        }

        // --- HESAPLAMA MOTORU ---

        function calculateLoad() {
            if (cargoItems.length === 0) {
                alert("Lütfen önce listeye ürün ekleyin.");
                return;
            }

            const pW = parseFloat(document.getElementById('pal-width').value);
            const pL = parseFloat(document.getElementById('pal-length').value);
            const pH = parseFloat(document.getElementById('pal-height').value);
            const pMaxWeight = parseFloat(document.getElementById('pal-weight').value);
            const palletVolume = pW * pL * pH;
            
            let itemPool = [];
            cargoItems.forEach(group => {
                for(let i=0; i < group.qty; i++) {
                    itemPool.push({...group});
                }
            });

            // Sıralama: Hacme göre büyükten küçüğe
            itemPool.sort((a, b) => b.volume - a.volume);

            let pallets = [];
            let currentPallet = createNewPallet(pW, pL, pH, pMaxWeight);

            itemPool.forEach(item => {
                let fits = true;

                if (item.w > pW && item.w > pL) fits = false; // Basit boyut kontrolü
                if (item.l > pW && item.l > pL) fits = false;
                if (item.h > pH) fits = false;

                if (currentPallet.currentWeight + item.weight > pMaxWeight) fits = false;
                
                // %90 Hacim verimliliği
                if (currentPallet.currentVolume + item.volume > palletVolume * 0.90) fits = false;

                if (fits) {
                    currentPallet.items.push(item);
                    currentPallet.currentWeight += item.weight;
                    currentPallet.currentVolume += item.volume;
                } else {
                    if (currentPallet.items.length > 0) pallets.push(currentPallet);
                    
                    currentPallet = createNewPallet(pW, pL, pH, pMaxWeight);
                    
                    // Yeni palete sığıyor mu? Sığmıyorsa bile (çok büyük parça) ekleyip uyarı/hata vermek gerekir ama şimdilik ekliyoruz.
                    currentPallet.items.push(item);
                    currentPallet.currentWeight += item.weight;
                    currentPallet.currentVolume += item.volume;
                }
            });

            if (currentPallet.items.length > 0) {
                pallets.push(currentPallet);
            }

            renderResults(pallets, pW, pL, pH);
        }

        function createNewPallet(w, l, h, maxW) {
            return {
                items: [],
                currentWeight: 0,
                currentVolume: 0,
                maxVol: w * l * h,
                maxWeight: maxW
            };
        }

        function renderResults(pallets, pW, pL, pH) {
            const resultsDiv = document.getElementById('results-area');
            const summaryDiv = document.getElementById('summary-stats');
            
            summaryDiv.classList.remove('hidden');
            summaryDiv.innerHTML = `<span class="font-bold text-blue-800 text-lg">${pallets.length} Palet</span> Gerekiyor.`;

            let html = '';
            
            pallets.forEach((pallet, index) => {
                const volPercentage = Math.min(100, Math.round((pallet.currentVolume / pallet.maxVol) * 100));
                const weightPercentage = Math.min(100, Math.round((pallet.currentWeight / pallet.maxWeight) * 100));
                
                const groupedItems = {};
                pallet.items.forEach(item => {
                    if(!groupedItems[item.name]) groupedItems[item.name] = 0;
                    groupedItems[item.name]++;
                });

                let itemsListHtml = '';
                for (const [name, qty] of Object.entries(groupedItems)) {
                    itemsListHtml += `<li class="flex justify-between border-b border-gray-100 py-1 last:border-0"><span class="text-gray-700">${name}</span> <span class="font-bold text-gray-900">x${qty}</span></li>`;
                }

                html += `
                <div class="pallet-box bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm relative">
                    <div class="bg-blue-600 text-white p-3 flex justify-between items-center">
                        <h3 class="font-bold">Palet #${index + 1}</h3>
                        <span class="text-xs bg-blue-500 px-2 py-1 rounded border border-blue-400 text-white shadow-sm">${pW}x${pL}x${pH}</span>
                    </div>
                    
                    <div class="p-4">
                        <div class="mb-4 space-y-3">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-500">Hacimsel Doluluk</span>
                                    <span class="font-bold ${volPercentage > 90 ? 'text-red-600' : 'text-green-600'}">%${volPercentage}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-green-500 h-2.5 rounded-full" style="width: ${volPercentage}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-500">Ağırlık (${pallet.currentWeight.toFixed(1)} / ${pallet.maxWeight} kg)</span>
                                    <span class="font-bold ${weightPercentage > 90 ? 'text-red-600' : 'text-blue-600'}">%${weightPercentage}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${weightPercentage}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">İçerik Listesi</h4>
                            <ul class="text-sm space-y-1 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                ${itemsListHtml}
                            </ul>
                        </div>
                    </div>
                </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>